<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>KBS TV - AutoPlay Priority</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        .layer { position: absolute; overflow: hidden; }
        .video-js { width: 100% !important; height: 100% !important; }
        .vjs-tech { object-fit: fill !important; } 
        .news-box { padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
        .news-card { background: #1e293b; border-radius: 20px; overflow: hidden; margin-bottom: 15px; flex: 1; display: flex; flex-direction: column; }
        .news-card img { width: 100%; height: 45%; object-fit: cover; }
        .content { padding: 20px; }
        .tag { background: #d32f2f; padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; display: inline-block; font-weight: bold; }
        #weather-panel { display: none; height: 100%; padding: 25px; box-sizing: border-box; background: #0f172a; border-radius: 20px; text-align: center; }
        .temp-grande { font-size: 4.5rem; font-weight: bold; color: #f59e0b; }
        .banner-img { position: absolute; object-fit: fill; z-index: 50; }
    </style>
</head>
<body onclick="player.muted(false); player.play();">

    <div id="v-layer" class="layer">
        <video id="my-video" class="video-js vjs-default-skin" playsinline muted></video>
    </div>
    
    <div id="n-layer" class="layer news-box">
        <div id="rotator" style="height: 100%;"></div>
        <div id="weather-panel">
            <h1 style="text-align: left;">PrevisÃ£o do Tempo</h1>
            <div style="display: flex; justify-content: space-around; background: linear-gradient(135deg, #1e293b, #334155); padding: 20px; border-radius: 30px;">
                <div><div class="temp-grande" id="current-temp">--Â°C</div><div>Agora</div></div>
                <div style="text-align: left;">ðŸ’§ Humidade: <span id="humidity">--</span>%<br>ðŸ’¨ Vento: <span id="wind">--</span> km/h</div>
            </div>
            <div style="height: 180px; margin-top: 15px;"><canvas id="weatherChart"></canvas></div>
        </div>
    </div>
    <div id="banners-container"></div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const config = { apiKey: "AIzaSyCvjIztzLkcCg1Tz24F6FphT4z-o1gvDU0", databaseURL: "https://assemco-8331e-default-rtdb.firebaseio.com", projectId: "assemco-8331e" };
        const app = initializeApp(config);
        const rtdb = getDatabase(app);
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyAGdlkrOftGtg5RaTVVF-enXzE4uQaYoLM", projectId: "jornal-automatico" }, "news"));

        const ORIGINAL_URL = "https://srv3.zcast.com.br/kbstv/kbstv/playlist.m3u8";
        window.player = videojs('my-video', {
            autoplay: 'any', // Tenta qualquer forma de autoplay
            controls: false,
            preload: 'auto',
            fluid: false
        });

        // --- SISTEMA DE ÃUDIO AGRESSIVO ---
        function forcePlay() {
            player.src({ src: ORIGINAL_URL, type: "application/x-mpegURL" });
            
            // 1. Toca no mudo (Garante o autoplay)
            player.muted(true);
            player.play().then(() => {
                // 2. ApÃ³s tocar, tenta tirar o mudo repetidamente
                let count = 0;
                let retryMute = setInterval(() => {
                    player.muted(false);
                    player.volume(1);
                    if (!player.muted() || count > 10) clearInterval(retryMute);
                    count++;
                }, 1000);
            }).catch(err => {
                console.log("Browser bloqueou tudo, tentando novamente...");
                setTimeout(forcePlay, 2000);
            });
        }

        // Executa ao carregar
        forcePlay();

        // Anti-travamento (4 segundos)
        let lastT = -1;
        setInterval(() => {
            if (player.paused()) player.play(); // Garante que nÃ£o fique pausado
            let currT = player.currentTime();
            if (currT === lastT) { forcePlay(); }
            lastT = currT;
        }, 4000);

        // Reset de seguranÃ§a (3 minutos)
        setInterval(forcePlay, 180000);

        // --- RESTO DA LÃ“GICA (BANNERS/NOTICIAS) ---
        onValue(ref(rtdb, 'kbs_multi_v1'), (snap) => {
            const s = snap.val(); if(!s) return;
            const up = (id, d) => { const el = document.getElementById(id); el.style.left = d.x + "%"; el.style.top = d.y + "%"; el.style.width = d.w + "%"; el.style.height = d.h + "%"; };
            up('v-layer', s.video); up('n-layer', s.news);
            document.getElementById('n-layer').style.backgroundColor = s.nBg;
            const bCont = document.getElementById('banners-container');
            bCont.innerHTML = ""; 
            if(s.banners) {
                Object.values(s.banners).forEach(b => {
                    if(b.url) {
                        const img = document.createElement('img');
                        img.className = "banner-img"; img.src = b.url;
                        img.style.left = b.x + "%"; img.style.top = b.y + "%";
                        img.style.width = b.w + "%"; img.style.height = b.h + "%";
                        bCont.appendChild(img);
                    }
                });
            }
        });

        // LÃ³gica de notÃ­cias e clima (resumida para manter foco no vÃ­deo)
        let allArticles = []; let currentIndex = 0; let isWeather = false;
        async function showWeather() {
            isWeather = true; document.getElementById("rotator").style.display = "none";
            document.getElementById("weather-panel").style.display = "block";
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=-25.4278&longitude=-49.2731&current=temperature_2m,relative_humidity_2m,wind_speed_10m&hourly=temperature_2m&timezone=America%2FSao_Paulo&forecast_days=1`);
                const data = await res.json();
                document.getElementById('current-temp').innerText = Math.round(data.current.temperature_2m) + 'Â°C';
                document.getElementById('humidity').innerText = data.current.relative_humidity_2m;
                document.getElementById('wind').innerText = data.current.wind_speed_10m;
            } catch (e) {}
            setTimeout(() => { isWeather = false; currentIndex = 0; rotation(); }, 20000);
        }
        function rotation() {
            if (isWeather) return;
            const container = document.getElementById("rotator");
            document.getElementById("weather-panel").style.display = "none";
            container.style.display = "block";
            const block = allArticles.slice(currentIndex, currentIndex + 2);
            if (block.length === 0) { showWeather(); return; }
            container.innerHTML = block.map(a => `<div class="news-card"><img src="${a.cover || ''}"><div class="content"><div class="tag">${a.tag || 'Geral'}</div><h3>${a.title}</h3></div></div>`).join('');
            currentIndex += 2; setTimeout(rotation, 25000);
        }
        onSnapshot(query(collection(db, 'artifacts/default-app-id/users/pzyclksOaGTWrl3x3swL40JECw42/news')), (snap) => {
            allArticles = []; snap.forEach(doc => allArticles.push(doc.data()));
            if (allArticles.length > 0 && !isWeather && currentIndex === 0) rotation();
        });
    </script>
</body>
</html>
