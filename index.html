<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: 'Roboto', sans-serif; }
        .layer { position: absolute; overflow: hidden; transition: 0.3s ease-out; }
        .video-js { width: 100% !important; height: 100% !important; }
        .vjs-tech { object-fit: fill !important; } 
        #ad-img { width: 100%; height: 100%; }
        
        .news-box { display: flex; flex-direction: column; padding: 0; box-sizing: border-box; }
        #news-list { height: 100%; display: flex; flex-direction: column; gap: 2px; }
        .news-item { background: rgba(0,0,0,0.2); flex: 1; overflow: hidden; display: flex; flex-direction: column; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative; }
        .n-img { width: 100%; height: 55%; object-fit: cover; }
        .n-txt { padding: 15px; color: white; font-weight: 900; font-size: 1.8rem; line-height: 1.1; text-transform: uppercase; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .n-badge { background: #ff0000; color: white; font-size: 0.8rem; padding: 2px 8px; width: fit-content; margin: 10px 15px 0 15px; font-weight: bold; }

        /* BLOCO DE PREVISÃO DO TEMPO */
        .weather-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .weather-temp { font-size: 1.5rem; font-weight: 900; color: #facc15; }
        .weather-city { font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; }
    </style>
</head>
<body>
    <div id="v-layer" class="layer"><video id="player" class="video-js vjs-default-skin" playsinline></video></div>
    <div id="b-layer" class="layer"><img id="ad-img" src=""></div>
    <div id="n-layer" class="layer news-box"><div id="news-list"></div></div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const config = { apiKey: "AIzaSyCvjIztzLkcCg1Tz24F6FphT4z-o1gvDU0", databaseURL: "https://assemco-8331e-default-rtdb.firebaseio.com", projectId: "assemco-8331e" };
        const app = initializeApp(config);
        const rtdb = getDatabase(app);
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyAGdlkrOftGtg5RaTVVF-enXzE4uQaYoLM", projectId: "jornal-automatico" }, "news"));

        // --- PLAYER COM ANTI-TRAVA ---
        const player = videojs('player', { autoplay: true, muted: false, controls: false, fluid: false });
        const streamUrl = "https://srv3.zcast.com.br/kbstv/kbstv/playlist.m3u8";

        function carregarSinal() {
            player.src({ src: streamUrl + "?t=" + Date.now(), type: "application/x-mpegURL" });
            player.play().catch(() => { player.muted(true); player.play(); });
        }
        player.on('error', () => setTimeout(carregarSinal, 5000));
        let lastTime = -1;
        setInterval(() => {
            if (!player.paused()) {
                if (player.currentTime() === lastTime) carregarSinal();
                lastTime = player.currentTime();
            }
        }, 10000);
        carregarSinal();

        // --- SINCRONIA DE LAYOUT ---
        onValue(ref(rtdb, 'kbs_pro_v3'), (snap) => {
            const s = snap.val(); if(!s) return;
            const up = (id, d) => {
                const el = document.getElementById(id);
                el.style.left = d.x + "%"; el.style.top = d.y + "%";
                el.style.width = d.w + "%"; el.style.height = d.h + "%";
            };
            up('v-layer', s.video); up('b-layer', s.banner); up('n-layer', s.news);
            document.getElementById('n-layer').style.backgroundColor = s.nBg;
            const img = document.getElementById('ad-img');
            img.style.objectFit = s.bFit || 'fill';
            if(s.bUrl) img.src = s.bUrl;
        });

        // --- NOTÍCIAS COM CLIMA E 25 SEGUNDOS ---
        const nRef = collection(db, 'artifacts/default-app-id/users/pzyclksOaGTWrl3x3swL40JECw42/news');
        let arts = []; let i = 0;

        function show() {
            const list = document.getElementById("news-list");
            const p = arts.slice(i, i + 2);
            if (p.length > 0) {
                list.innerHTML = p.map(a => `
                    <div class="news-item">
                        <img src="${a.cover}" class="n-img">
                        <div class="weather-info">
                            <div class="weather-temp">${a.temp || '--'}°</div>
                            <div class="weather-city">${a.city || 'KBS'}</div>
                        </div>
                        <div class="n-badge">KBS NOTÍCIAS</div>
                        <div class="n-txt">${a.title}</div>
                    </div>
                `).join('');
                i = (i + 2) % arts.length;
            }
            setTimeout(show, 25000); // MUDADO PARA 25 SEGUNDOS
        }
        onSnapshot(query(nRef), (s) => { arts = []; s.forEach(d => arts.push(d.data())); if(arts.length > 0 && i === 0) show(); });
    </script>
</body>
</html>
