<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>KBS TV - Receptor</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: 'Segoe UI', Roboto, sans-serif; color: white; }
        .layer { position: absolute; overflow: hidden; transition: 0.3s ease-out; }
        
        /* PLAYER ANTI-TRAVA PREENCHIDO */
        .video-js { width: 100% !important; height: 100% !important; }
        .vjs-tech { object-fit: fill !important; } 

        #ad-img { width: 100%; height: 100%; }

        /* DESIGN DAS NOT√çCIAS (SEU PADR√ÉO) */
        .news-box { padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px; }
        .news-card { background: #1e293b; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.4); animation: fadeIn 0.8s ease; flex: 1; display: flex; flex-direction: column; }
        .news-card img { width: 100%; height: 45%; object-fit: cover; }
        .content { padding: 15px; }
        .tag { background: #d32f2f; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; display: inline-block; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
        .title { font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; line-height: 1.2; color: #fff; }
        .summary { font-size: 0.9rem; opacity: 0.8; line-height: 1.3; }

        /* DESIGN DO CLIMA (SEU PADR√ÉO) */
        #weather-panel { display: none; height: 100%; padding: 15px; box-sizing: border-box; text-align: center; background: #0f172a; border-radius: 15px; }
        .current-weather { display: flex; justify-content: space-around; align-items: center; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 15px; border-radius: 20px; margin-bottom: 10px; text-align: left; }
        .temp-grande { font-size: 3.5rem; font-weight: bold; color: #f59e0b; }
        .chart-container { height: 150px; background: rgba(30, 41, 59, 0.5); padding: 10px; border-radius: 15px; }
        .qr-section { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 10px; }
        .qr-code-img { width: 100px; height: 100px; background: white; padding: 5px; border-radius: 10px; }
        .qr-call { font-size: 0.9rem; font-weight: 800; color: #38bdf8; text-transform: uppercase; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="v-layer" class="layer"><video id="player" class="video-js vjs-default-skin" playsinline></video></div>
    <div id="b-layer" class="layer"><img id="ad-img" src=""></div>
    
    <div id="n-layer" class="layer news-box">
        <div id="rotator" style="height: 100%;"></div>
        
        <div id="weather-panel">
            <h2 style="font-size: 1rem; margin: 0 0 10px 0; text-align: left;">PREVIS√ÉO: CURITIBA</h2>
            <div class="current-weather">
                <div><div class="temp-grande" id="current-temp">--¬∞</div></div>
                <div style="font-size: 0.9rem;">üíß <span id="humidity">--</span>% <br>üí® <span id="wind">--</span>km/h</div>
            </div>
            <div class="chart-container"><canvas id="weatherChart"></canvas></div>
            <div class="qr-section">
                <img class="qr-code-img" src="https://i.imgur.com/UfQjAQy.png">
                <div class="qr-call">JORNAL DA KBS TV</div>
            </div>
        </div>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const config = { apiKey: "AIzaSyCvjIztzLkcCg1Tz24F6FphT4z-o1gvDU0", databaseURL: "https://assemco-8331e-default-rtdb.firebaseio.com", projectId: "assemco-8331e" };
        const app = initializeApp(config);
        const rtdb = getDatabase(app);
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyAGdlkrOftGtg5RaTVVF-enXzE4uQaYoLM", projectId: "jornal-automatico" }, "news"));

        // --- PLAYER ANTI-TRAVA ---
        const player = videojs('player', { autoplay: true, muted: false, controls: false });
        const streamUrl = "https://srv3.zcast.com.br/kbstv/kbstv/playlist.m3u8";
        function loadSinal() { 
            player.src({ src: streamUrl + "?t=" + Date.now(), type: "application/x-mpegURL" }); 
            player.play().catch(() => { player.muted(true); player.play(); });
        }
        player.on('error', () => setTimeout(loadSinal, 5000));
        let lastT = -1; setInterval(() => { if(!player.paused()){ if(player.currentTime()===lastT) loadSinal(); lastT=player.currentTime(); } }, 10000);
        loadSinal();

        // --- CONTROLE DE LAYOUT ---
        onValue(ref(rtdb, 'kbs_pro_v3'), (snap) => {
            const s = snap.val(); if(!s) return;
            const up = (id, d) => { const el = document.getElementById(id); el.style.left = d.x + "%"; el.style.top = d.y + "%"; el.style.width = d.w + "%"; el.style.height = d.h + "%"; };
            up('v-layer', s.video); up('b-layer', s.banner); up('n-layer', s.news);
            document.getElementById('n-layer').style.backgroundColor = s.nBg;
            if(s.bUrl) document.getElementById('ad-img').src = s.bUrl;
            document.getElementById('ad-img').style.objectFit = s.bFit || 'fill';
        });

        // --- L√ìGICA DE NOT√çCIAS E CLIMA ---
        let allArticles = []; let currentIndex = 0; let isWeatherShowing = false; let chartInstance = null;

        async function showWeather() {
            isWeatherShowing = true;
            document.getElementById("rotator").style.display = "none";
            document.getElementById("weather-panel").style.display = "block";
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=-25.4278&longitude=-49.2731&current=temperature_2m,relative_humidity_2m,wind_speed_10m&hourly=temperature_2m&forecast_days=1`);
                const data = await res.json();
                document.getElementById('current-temp').innerText = Math.round(data.current.temperature_2m) + '¬∞';
                document.getElementById('humidity').innerText = data.current.relative_humidity_2m;
                document.getElementById('wind').innerText = data.current.wind_speed_10m;
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(document.getElementById('weatherChart'), {
                    type: 'line',
                    data: {
                        labels: data.hourly.time.filter((_, i) => i % 4 === 0).map(t => t.split('T')[1]),
                        datasets: [{ data: data.hourly.temperature_2m.filter((_, i) => i % 4 === 0), borderColor: '#f59e0b', fill: true, backgroundColor: 'rgba(245, 158, 11, 0.1)', tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { color: '#fff' } } } }
                });
            } catch (e) {}
            setTimeout(() => { isWeatherShowing = false; currentIndex = 0; rotation(); }, 20000);
        }

        function rotation() {
            if (isWeatherShowing) return;
            const container = document.getElementById("rotator");
            document.getElementById("weather-panel").style.display = "none";
            container.style.display = "block";

            const block = allArticles.slice(currentIndex, currentIndex + 2);
            if (block.length === 0) { showWeather(); return; }

            container.innerHTML = block.map(a => `
                <div class="news-card">
                    <img src="${a.cover || 'https://placehold.co/400x200/333/fff?text=KBS+TV'}">
                    <div class="content">
                        <div class="tag">${a.tag || 'Destaque'}</div>
                        <div class="title">${a.title}</div>
                        <div class="summary">${a.summary ? a.summary.substring(0, 80) + '...' : ''}</div>
                    </div>
                </div>
            `).join('');

            currentIndex += 2;
            setTimeout(rotation, 25000); // Dura√ß√£o de 25 segundos
        }

        onSnapshot(query(collection(db, 'artifacts/default-app-id/users/pzyclksOaGTWrl3x3swL40JECw42/news')), (snap) => {
            allArticles = []; snap.forEach(doc => allArticles.push(doc.data()));
            if (allArticles.length > 0 && !isWeatherShowing && currentIndex === 0) rotation();
        });
    </script>
</body>
</html>
